# CORSエラーの原因と対策

## 原因

CORS（Cross-Origin Resource Sharing）エラーが発生する主な原因は以下の通りです：

1. **ブラウザのセキュリティポリシー**
   - ブラウザは、異なるオリジン（ドメイン、プロトコル、ポート）からのリクエストを制限します
   - DifyのAPIサーバーがCORSヘッダーを適切に設定していない場合、ブラウザがリクエストをブロックします

2. **Dify APIの設定**
   - DifyのAPIサーバーが、ブラウザからの直接アクセスを許可していない可能性があります
   - セキュリティ上の理由で、APIキーをブラウザに露出させない設計になっている場合があります

## 対策

### 1. Next.js APIルートを使用したプロキシ（実装済み）

**解決方法**: Next.jsのAPIルート（`/app/api/dify/route.ts`）を作成し、サーバー側からDify APIにリクエストを転送します。

**メリット**:
- CORS問題を完全に回避
- APIキーをサーバー側で処理し、クライアントに露出しない
- セキュリティが向上

**動作**:
1. クライアント側から `/api/dify` にリクエストを送信
2. Next.jsのサーバー側でDify APIにリクエストを転送
3. レスポンスをクライアントに返す

### 2. Dify APIエンドポイントの確認

**ワークフローアプリの場合**:
- エンドポイント: `https://api.dify.ai/v1/chat-messages`
- または: `https://api.dify.ai/v1/workflows/run`（ワークフロー専用エンドポイントの場合）

**チャットアプリの場合**:
- エンドポイント: `https://api.dify.ai/v1/chat-messages`

### 3. APIキーの確認

1. Difyのダッシュボードで「API アクセス」を開く
2. 「APIキー」を確認
3. 正しいAPIキーが設定されているか確認

### 4. エンドポイントURLの確認

Difyのワークフローアプリの場合：
- Difyのダッシュボードで「API アクセス」を開く
- 「エンドポイント」を確認
- 正しいエンドポイントURLをコピーして設定

## トラブルシューティング

### エラーが続く場合

1. **APIエンドポイントの確認**
   - Difyのダッシュボードで「API アクセス」を開く
   - 表示されているエンドポイントURLを確認
   - そのURLをそのままコピーして設定

2. **APIキーの確認**
   - APIキーが正しくコピーされているか確認
   - 余分なスペースや改行が含まれていないか確認

3. **ワークフローの公開状態**
   - ワークフローが「公開済み」になっているか確認
   - 公開されていない場合、APIからアクセスできません

4. **ネットワーク接続の確認**
   - インターネット接続が正常か確認
   - ファイアウォールやプロキシの設定を確認

## 参考資料

- [Dify API Documentation](https://docs.dify.ai/api-reference)
- [Next.js API Routes](https://nextjs.org/docs/app/building-your-application/routing/route-handlers)

